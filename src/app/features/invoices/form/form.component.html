<form (ngSubmit)="submit()" novalidate class="my-6" [formGroup]="form">
  <div class="max-w-7xl mx-auto bg-white p-8 rounded-md shadow-md">
    <div class="mb-4">
      <h2 class="text-2xl font-bold mb-2">{{ titleForm }} Invoice</h2>
    </div>
    <div class="mb-4">
      <h2 class="text-2xl font-bold mb-2">{{this.user.name + " " + this.user.surname}}</h2>
    </div>
    <div class="mb-4">
      <label for="date" class="block text-sm font-medium text-gray-700">Date</label>
      <input
        type="date"
        id="date"
        formControlName="date"
        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
      />
      <div *ngIf="form.get('date').touched && form.get('date').invalid" class="text-red-600 text-sm mt-1">
        {{ errorHandling('date') }}
      </div>
    </div>
    
    <div class="mb-4">
      <label for="branch" class="block text-sm font-medium text-gray-700">Branch</label>
      <select
        id="branch"
        formControlName="branchId"
        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
      >
        <option *ngFor="let branch of branchList" [value]="branch.id">{{ branch.name }}</option>
      </select>
      <div *ngIf="form.get('branchId').touched && form.get('branchId').invalid" class="text-red-600 text-sm mt-1">
        {{ errorHandling('branchId') }}
      </div>
    </div>

    <div class="mb-4">
      <label for="user" class="block text-sm font-medium text-gray-700">User</label>
      <select
        id="user"
        formControlName="userId"
        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
      >
        <option *ngFor="let user of userList" [value]="user.id">{{ user.name }}</option>
      </select>
      <div *ngIf="form.get('userId').touched && form.get('userId').invalid" class="text-red-600 text-sm mt-1">
        {{ errorHandling('userId') }}
      </div>
    </div>

    <div class="mb-4">
      <label for="total" class="block text-sm font-medium text-gray-700">Total</label>
      <input
        type="text"
        id="total"
        formControlName="total"
        placeholder="Total"
        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
        readonly
      />
    </div>

    <div formArrayName="invoiceDetails" class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead>
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Service</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subtotal</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <tr *ngFor="let detail of invoiceDetails.controls; let i = index" [formGroupName]="i">
            <td class="px-6 py-4 whitespace-nowrap">
              <select
                formControlName="serviceId"
                (change)="onServiceOrProductChange(i)"
                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
              >
                <option value="">Select a service</option>
                <option *ngFor="let service of serviceList" [value]="service.id">{{ service.name }}</option>
              </select>
              <div *ngIf="(detail.get('serviceId').touched || detail.get('productId').touched) && detail.get('serviceId').invalid" class="text-red-600 text-sm mt-1">
                {{ errorHandlingDetail(i, 'serviceId') }}
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <select
                formControlName="productId"
                (change)="onServiceOrProductChange(i)"
                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
              >
                <option value="">Select a product</option>
                <option *ngFor="let product of productList" [value]="product.id">{{ product.name }}</option>
              </select>
              <div *ngIf="(detail.get('serviceId').touched || detail.get('productId').touched) && detail.get('productId').invalid" class="text-red-600 text-sm mt-1">
                {{ errorHandlingDetail(i, 'productId') }}
              </div>
              <div *ngIf="(detail.get('serviceId').touched || detail.get('productId').touched) && detail?.errors?.['serviceOrProductRequired']" class="text-red-600 text-sm mt-1">
                Either a Service or a Product must be selected.
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <input
                type="number"
                formControlName="quantity"
                placeholder="Quantity"
                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                [attr.max]="getMaxQuantity(i)"
                (change)="onProductOrServiceQuantityChange(i); updateSubtotal(i)"
              />
              <div *ngIf="detail.get('quantity').touched && detail.get('quantity').invalid" class="text-red-600 text-sm mt-1">
                {{ errorHandlingDetail(i, 'quantity') }}
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <input
                type="text"
                formControlName="price"
                placeholder="Price"
                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                readonly
              />
              <div *ngIf="detail.get('price').touched && detail.get('price').invalid" class="text-red-600 text-sm mt-1">
                {{ errorHandlingDetail(i, 'price') }}
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <input
                type="text"
                formControlName="subtotal"
                placeholder="Subtotal"
                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                readonly
              />
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <button
                type="button"
                (click)="removeDetail(i)"
                class="bg-red-500 text-white py-2 px-4 rounded-md shadow-md hover:bg-red-600"
              >
                Remove
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <button
      type="button"
      (click)="addDetail()"
      class="mb-4 bg-green-500 text-white py-2 px-4 rounded-md shadow-md hover:bg-green-600"
    >
      Add Detail
    </button>

    <div class="flex space-x-4">
      <button
        type="button"
        (click)="onReset()"
        class="bg-red-500 text-white py-2 px-4 rounded-md shadow-md hover:bg-red-600"
      >
        Reset
      </button>
      <button
        type="submit"
        class="bg-blue-500 text-white py-2 px-4 rounded-md shadow-md hover:bg-blue-600"
      >
        Save
      </button>
    </div>
  </div>
</form>
<button mat-button (click)="openProductModal()">Seleccionar Producto</button>
<input matInput [value]="selectedProduct?.name" placeholder="Producto Seleccionado" readonly>